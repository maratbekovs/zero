<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO Help Desk - –ö–ª–∏–µ–Ω—Ç</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö */
        .chat-input-area {
            position: sticky; bottom: 0; z-index: 2; background: #fff;
            border-top: 1px solid #e2e8f0; padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
            display: flex; gap: 8px; align-items: center; flex-wrap: nowrap;
        }
        .chat-input-area #chat-input {
            flex: 1; min-width: 0; border-radius: 22px; padding: 12px 14px; font-size: 15px; min-height: 44px;
            border: 1px solid var(--border-color, #e2e8f0); outline: none;
        }
        .chat-input-area #chat-input:focus {
            border-color: var(--primary-color, #4361ee);
            box-shadow: 0 0 0 3px rgba(67,97,238,0.15);
        }
        .attach-toggle {
            background: #fff; border: 1px solid var(--border-color, #e2e8f0); color: var(--text-color, #2d3748);
            width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;
        }
        .send-button {
            width: 42px; height: 42px; border-radius: 12px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .attach-menu {
            position: absolute; right: 16px; bottom: 60px; z-index: 3;
            background: #fff; border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 8px; display: none; gap: 8px; align-items: center;
        }
        .attach-menu.open { display: flex; }
        .attach-menu .btn { width: auto; padding: 8px 10px; font-size: 13px; }

        #chat-attachment-preview.attachment-preview { display: none; }
        #chat-attachment-preview.attachment-preview.show { display: flex; }

        /* –ë–∞–Ω–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notif-banner { margin-top: 10px; color:#2a9d8f; font-size: 0.9em; }
        .notif-banner.error { color:#e63946; }

        @media (max-width: 768px){
            .chat-content { max-height: 85vh; }
        }
    </style>
</head>
<body>
    <div class="mobile-header"><h1>ZERO ü§ù Help Desk</h1></div>

    <div class="desktop-layout">
        <div class="sidebar">
            <div class="sidebar-header"><h1>ZERO ü§ù Help Desk</h1></div>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-tab="active-tickets"><i>üì±</i> –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</a>
                <a href="#" class="nav-link" data-tab="history-tickets"><i>üìã</i> –ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="#" class="nav-link" data-tab="profile"><i>üë§</i> –ü—Ä–æ—Ñ–∏–ª—å</a>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <p><strong id="sidebar-username"></strong></p>
                    <p id="sidebar-fullname"></p>
                    <p id="sidebar-phone"></p>
                </div>
                <button class="btn btn-danger logout-button">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="main-content">
            <div id="active-tickets" class="content-section active">
                <div class="section-header"><h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h2></div>

                <div class="card">
                    <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</h3>
                    <div id="ticket-message" class="alert hidden"></div>

                    <form id="create-ticket-form">
                        <div class="form-group">
                            <label for="room_number">–ù–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞:</label>
                            <input type="text" id="room_number" name="room_number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 312, –ê-104">
                        </div>

                        <div class="form-group">
                            <label for="subject">–¢–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∞:</label>
                            <input type="text" id="subject" name="subject" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É" required>
                        </div>

                        <div class="form-group">
                            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                            <textarea id="description" name="description" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É" required></textarea>
                        </div>

                        <div class="form-group">
                            <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ:</label>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                                <button type="button" id="btn-photo-capture" class="btn btn-muted btn-small">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                                <button type="button" id="btn-video-capture" class="btn btn-muted btn-small">–°–Ω—è—Ç—å –≤–∏–¥–µ–æ</button>
                                <button type="button" id="btn-pick-file" class="btn btn-outline btn-small">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                            </div>
                            <input type="file" id="attachment" name="attachment" accept="image/*,video/*" capture="environment" class="hidden">
                            <div id="attachment-preview" class="attachment-preview hidden"></div>
                        </div>

                        <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                    </form>
                </div>

                <div class="card">
                    <h3>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
                    <div class="table-container">
                        <table id="active-tickets-table" class="responsive">
                            <thead>
                            <tr><th>ID</th><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="history-tickets" class="content-section">
                <div class="section-header"><h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2></div>
                <div class="card">
                    <div class="table-container">
                        <table id="history-tickets-table" class="responsive">
                            <thead>
                            <tr><th>ID</th><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <p style="color:#6c757d; font-size:0.9em; margin-top:10px;">
                        –ü–æ–¥—Ä–æ–±–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–æ–π ¬´–ü—Ä–æ—Å–º–æ—Ç—Ä¬ª.
                    </p>
                </div>
            </div>

            <div id="profile" class="content-section">
                <div class="section-header"><h2>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2></div>
                <div id="auth-check-message" class="alert alert-error hidden">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>

                <div id="user-info-area">
                    <div class="card">
                        <h3>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="profile-info">
                            <p><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> <span id="user-username-display"></span></p>
                            <p><strong>–§–ò–û:</strong> <span id="user-fullname-display"></span></p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="user-phone-display"></span></p>
                        </div>
                        <button id="edit-user-info-button" class="btn btn-outline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        <div id="notification-status" class="notif-banner hidden"></div>
                    </div>

                    <form class="card hidden" id="edit-user-info-form">
                        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
                        <div id="user-info-message" class="alert hidden"></div>
                        <div class="form-group">
                            <label for="edit_full_name">–§–ò–û:</label>
                            <input type="text" id="edit_full_name" name="full_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
                        </div>
                        <div class="form-group">
                            <label for="edit_phone_number">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                            <input type="text" id="edit_phone_number" name="phone_number" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" id="cancel-edit-button" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>

                    <div class="card" id="notification-prompt">
                        <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <p>–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ç–∞—Ç—É—Å–∞.</p>
                        <button id="enable-notifications-button" class="btn">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                    </div>

                    <div class="card">
                        <h3>–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</h3>
                        <p>–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π</p>
                        <button id="logout-button" class="btn btn-danger">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-tab-bar">
        <a href="#" class="tab-item active" data-tab="active-tickets"><i>üì±</i><span>–ß–∞—Ç—ã</span></a>
        <a href="#" class="tab-item" data-tab="history-tickets"><i>üìã</i><span>–ò—Å—Ç–æ—Ä–∏—è</span></a>
        <a href="#" class="tab-item" data-tab="profile"><i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
    </div>

    <div id="chat-modal" class="chat-modal">
        <div class="chat-content">
            <div class="chat-header">
                <h2>–ß–∞—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É #<span id="chat-ticket-id"></span>: <span id="chat-ticket-subject"></span></h2>
                <span class="close-button" title="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">&times;</span>
            </div>

            <div id="chat-readonly-banner" class="chat-readonly-banner hidden">
                –≠—Ç–æ—Ç —á–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ–ª—å–∑—è. –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –≤–ª–æ–∂–µ–Ω–∏–π.
            </div>

            <div id="chat-box" class="chat-box"></div>

            <div class="chat-input-area" id="chat-input-area">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                <input type="file" id="chat-attachment" accept="image/*,video/*" capture="environment" style="display:none;">
                <button type="button" id="attach-toggle" class="attach-toggle" aria-label="–í–ª–æ–∂–µ–Ω–∏—è">Ôºã</button>
                <button id="chat-send-button" class="btn send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>

                <div class="attach-menu" id="attach-menu" role="menu" aria-hidden="true">
                    <button type="button" id="chat-pick-button" class="btn btn-outline btn-small">üìé –§–∞–π–ª</button>
                    <button type="button" id="chat-photo-button" class="btn btn-outline btn-small">üì∑ –§–æ—Ç–æ</button>
                    <button type="button" id="chat-video-button" class="btn btn-outline btn-small">üé• –í–∏–¥–µ–æ</button>
                </div>
            </div>

            <div id="chat-attachment-preview" class="attachment-preview" style="margin: 10px 20px;"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const API_BASE = '/api';

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        const navLinks = document.querySelectorAll('.nav-link');
        const tabItems = document.querySelectorAll('.tab-item');
        const contentSections = document.querySelectorAll('.content-section');

        // –ü—Ä–æ—Ñ–∏–ª—å
        const userUsernameDisplay = document.getElementById('user-username-display');
        const userFullnameDisplay = document.getElementById('user-fullname-display');
        const userPhoneDisplay = document.getElementById('user-phone-display');
        const sidebarUsername = document.getElementById('sidebar-username');
        const sidebarFullname = document.getElementById('sidebar-fullname');
        const sidebarPhone = document.getElementById('sidebar-phone');
        const editUserInfoButton = document.getElementById('edit-user-info-button');
        const editUserInfoForm = document.getElementById('edit-user-info-form');
        const userInfoMessage = document.getElementById('user-info-message');
        const editFullNameInput = document.getElementById('edit_full_name');
        const editPhoneNumberInput = document.getElementById('edit_phone_number');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notificationPrompt = document.getElementById('notification-prompt');
        const enableNotificationsButton = document.getElementById('enable-notifications-button');
        const notificationStatus = document.getElementById('notification-status');

        // –ó–∞—è–≤–∫–∏
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketMessage = document.getElementById('ticket-message');
        const activeTicketsTableBody = document.querySelector('#active-tickets-table tbody');
        const historyTicketsTableBody = document.querySelector('#history-tickets-table tbody');

        // –ü–æ–ª—è —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
        const roomNumberInput = document.getElementById('room_number');
        const subjectInput = document.getElementById('subject');
        const descriptionInput = document.getElementById('description');
        const attachmentInput = document.getElementById('attachment');
        const attachmentPreview = document.getElementById('attachment-preview');
        const btnPhotoCapture = document.getElementById('btn-photo-capture');
        const btnVideoCapture = document.getElementById('btn-video-capture');
        const btnPickFile = document.getElementById('btn-pick-file');

        // –ß–∞—Ç (Socket.IO)
        const socket = io('/', { withCredentials: true });
        let currentUserId = null;
        let currentUsername = null;
        let activeTicketId = null;
        let chatReadOnly = false;

        const chatModal = document.getElementById('chat-modal');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatTicketIdDisplay = document.getElementById('chat-ticket-id');
        const chatTicketSubjectDisplay = document.getElementById('chat-ticket-subject');
        const closeChatButton = document.querySelector('#chat-modal .close-button');
        const chatAttachmentInput = document.getElementById('chat-attachment');
        const chatAttachmentPreview = document.getElementById('chat-attachment-preview');
        const chatPhotoButton = document.getElementById('chat-photo-button');
        const chatVideoButton = document.getElementById('chat-video-button');
        const chatPickButton = document.getElementById('chat-pick-button');
        const chatInputArea = document.getElementById('chat-input-area');
        const chatReadonlyBanner = document.getElementById('chat-readonly-banner');
        const attachToggle = document.getElementById('attach-toggle');
        const attachMenu = document.getElementById('attach-menu');

        // RU —Å—Ç–∞—Ç—É—Å—ã
        const statusMapRU = { 'New':'–ù–æ–≤–∞—è','In Progress':'–í —Ä–∞–±–æ—Ç–µ','On Hold':'–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏','Successful':'–£—Å–ø–µ—à–Ω–æ','Rejected':'–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' };
        const toRu = s => statusMapRU[s] || (s || '‚Äî');

        // PWA: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {});
        }

        // Push: –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        function isPushSupported() {
            return 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window;
        }
        function showNotifStatus(text, isError=false){
            if (!notificationStatus) return;
            notificationStatus.textContent = text;
            notificationStatus.classList.remove('hidden','error');
            if (isError) notificationStatus.classList.add('error');
        }
        function urlBase64ToUint8Array(base64String) {
            if (!base64String) return new Uint8Array();
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        async function fetchVapidPublicKey(){
            const res = await fetch(`${API_BASE}/auth/vapid-public-key`);
            if (!res.ok) throw new Error('No VAPID public key');
            const data = await res.json();
            return data.publicKey;
        }
        async function registerServiceWorkerAndSubscribe() {
            if (!isPushSupported()) return { ok:false, reason:'not_supported' };
            try {
                const registration = await navigator.serviceWorker.ready;
                let subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                    const publicKey = await fetchVapidPublicKey();
                    const appServerKey = urlBase64ToUint8Array(publicKey);
                    subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
                }
                const res = await fetch(`${API_BASE}/auth/save-subscription`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ subscription })
                });
                if (!res.ok) throw new Error('save-subscription failed');
                return { ok:true };
            } catch (e) {
                return { ok:false, reason: e?.message || 'subscribe_error' };
            }
        }
        async function refreshPushUI() {
            if (!isPushSupported()) {
                notificationPrompt?.classList.add('hidden');
                return;
            }
            if (Notification.permission === 'granted') {
                await registerServiceWorkerAndSubscribe();
                notificationPrompt?.classList.add('hidden');
                showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.');
            } else if (Notification.permission === 'denied') {
                notificationPrompt?.classList.add('hidden');
                showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', true);
            } else {
                notificationPrompt?.classList.remove('hidden');
            }
        }
        enableNotificationsButton?.addEventListener('click', async () => {
            if (!isPushSupported()) { showNotifStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Push.', true); return; }
            try {
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') {
                    showNotifStatus('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.', true);
                    return;
                }
                const result = await registerServiceWorkerAndSubscribe();
                if (result.ok) {
                    showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.');
                    notificationPrompt?.classList.add('hidden');
                } else {
                    showNotifStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.', true);
                }
            } catch (e) {
                showNotifStatus('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.', true);
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function switchTab(tabId) {
            contentSections.forEach(section => section.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            navLinks.forEach(link => { link.classList.remove('active'); if (link.dataset.tab === tabId) link.classList.add('active'); });
            tabItems.forEach(item => { item.classList.remove('active'); if (item.dataset.tab === tabId) item.classList.add('active'); });
            if (tabId === 'active-tickets') loadUserTickets();
            if (tabId === 'history-tickets') loadHistoryTickets();
        }
        navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); switchTab(link.dataset.tab); }));
        tabItems.forEach(item => item.addEventListener('click', e => { e.preventDefault(); switchTab(item.dataset.tab); }));

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function getAuthStatus() {
            try {
                const res = await fetch(`${API_BASE}/auth/status`, { credentials: 'include' });
                const data = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : {};
                if (!data.isLoggedIn) { window.location.href = '/'; return null; }
                currentUserId = data.userId; currentUsername = data.username;
                updateUserInfoDisplay({ username: data.username, full_name: data.full_name, phone_number: data.phone_number });
                await refreshPushUI();
                return data;
            } catch (e) {
                showMessage(document.getElementById('auth-check-message'), 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
                return null;
            }
        }
        function updateUserInfoDisplay(userData) {
            const fullName = userData.full_name || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';
            const phoneNumber = userData.phone_number || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';
            userUsernameDisplay.textContent = userData.username;
            userFullnameDisplay.textContent = fullName;
            userPhoneDisplay.textContent = phoneNumber;
            sidebarUsername.textContent = userData.username;
            sidebarFullname.textContent = fullName;
            sidebarPhone.textContent = phoneNumber;
        }
        document.querySelectorAll('.logout-button, #logout-button').forEach(btn => btn.addEventListener('click', async () => {
            try { await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' }); } finally { window.location.href = '/'; }
        }));

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        editUserInfoButton.addEventListener('click', () => {
            document.querySelector('#profile .card:not(#edit-user-info-form)').classList.add('hidden');
            editUserInfoForm.classList.remove('hidden');
            editFullNameInput.value = userFullnameDisplay.textContent === '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ' ? '' : userFullnameDisplay.textContent;
            editPhoneNumberInput.value = userPhoneDisplay.textContent === '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ' ? '' : userPhoneDisplay.textContent;
            hideMessage(userInfoMessage);
        });
        cancelEditButton.addEventListener('click', () => {
            editUserInfoForm.classList.add('hidden');
            document.querySelector('#profile .card:not(#edit-user-info-form)').classList.remove('hidden');
            hideMessage(userInfoMessage);
        });
        editUserInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = editFullNameInput.value.trim();
            const phoneNumber = editPhoneNumberInput.value.trim();
            try {
                const res = await fetch(`${API_BASE}/auth/update-profile`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                    body: JSON.stringify({ fullName, phoneNumber })
                });
                const isJson = (res.headers.get('content-type')||'').includes('application/json');
                const data = isJson ? await res.json() : { message: await res.text() };
                if (res.ok) {
                    showMessage(userInfoMessage, 'alert-success', data.message || '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                    updateUserInfoDisplay({ username: currentUsername, full_name: fullName, phone_number: phoneNumber });
                    setTimeout(() => {
                        editUserInfoForm.classList.add('hidden');
                        document.querySelector('#profile .card:not(#edit-user-info-form)').classList.remove('hidden');
                        hideMessage(userInfoMessage);
                    }, 800);
                } else {
                    showMessage(userInfoMessage, 'alert-error', data.message || `–û—à–∏–±–∫–∞ (${res.status}).`);
                }
            } catch (err) {
                showMessage(userInfoMessage, 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        function showMessage(element, type, text) { element.textContent = text; element.className = `alert ${type}`; element.classList.remove('hidden'); }
        function hideMessage(element) { element.classList.add('hidden'); }
        function formatDate(dt) { try { return new Date(dt).toLocaleString(); } catch { return dt; } }
        function escapeHtml(s) { return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
        function formatBytes(bytes) { if (!bytes && bytes !== 0) return ''; const k = 1024; const sizes = ['B','KB','MB','GB']; const i = Math.floor(Math.log(bytes)/Math.log(k)); return `${(bytes/Math.pow(k,i)).toFixed(1)} ${sizes[i]}`; }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–ª–æ–∂–µ–Ω–∏—è
        function renderAttachmentPreview(container, file, clearCb) {
            container.innerHTML = '';
            if (!file) { container.classList.remove('show'); container.classList.add('hidden'); return; }
            const wrap = document.createElement('div');
            wrap.style.display = 'flex'; wrap.style.gap = '12px'; wrap.style.alignItems = 'center'; wrap.style.flexWrap = 'wrap';

            const isImage = (file.type || '').startsWith('image/');
            const isVideo = (file.type || '').startsWith('video/');
            let thumb;
            if (isImage) {
                thumb = Object.assign(document.createElement('img'), { className: 'attachment-thumb', alt: '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä', src: URL.createObjectURL(file) });
            } else if (isVideo) {
                thumb = Object.assign(document.createElement('video'), { className: 'attachment-thumb', src: URL.createObjectURL(file), controls: true, muted: true });
            } else {
                thumb = document.createElement('div');
                thumb.textContent = '–§–∞–π–ª';
                thumb.style.padding = '10px';
                thumb.style.background = '#e9ecef';
                thumb.style.borderRadius = '8px';
            }

            const meta = document.createElement('div');
            meta.className = 'attachment-meta';
            meta.innerHTML = `<div><strong>${file.name}</strong></div><div>${file.type || '—Ñ–∞–π–ª'} ‚Ä¢ ${formatBytes(file.size)}</div>`;

            const actions = document.createElement('div');
            actions.className = 'attachment-actions';
            const btnRemove = document.createElement('button');
            btnRemove.type = 'button'; btnRemove.className = 'btn btn-danger btn-small';
            btnRemove.textContent = '–£–¥–∞–ª–∏—Ç—å';
            btnRemove.addEventListener('click', () => { clearCb(); if (thumb.src) URL.revokeObjectURL(thumb.src); container.innerHTML=''; container.classList.remove('show'); container.classList.add('hidden'); });
            actions.appendChild(btnRemove);

            wrap.appendChild(thumb); wrap.appendChild(meta); wrap.appendChild(actions);
            container.appendChild(wrap);
            container.classList.remove('hidden');
            container.classList.add('show');
        }

        btnPickFile.addEventListener('click', () => {
            attachmentInput.accept = 'image/*,video/*';
            attachmentInput.removeAttribute('capture');
            attachmentInput.click();
        });
        btnPhotoCapture.addEventListener('click', () => {
            attachmentInput.accept = 'image/*';
            attachmentInput.setAttribute('capture', 'environment');
            attachmentInput.click();
        });
        btnVideoCapture.addEventListener('click', () => {
            attachmentInput.accept = 'video/*';
            attachmentInput.setAttribute('capture', 'environment');
            attachmentInput.click();
        });
        attachmentInput.addEventListener('change', () => {
            const file = attachmentInput.files?.[0] || null;
            renderAttachmentPreview(attachmentPreview, file, () => { attachmentInput.value = ''; });
            attachmentInput.accept = 'image/*,video/*';
            attachmentInput.setAttribute('capture', 'environment');
        });

        createTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomNumber = roomNumberInput.value.trim();
            const subject = subjectInput.value.trim();
            const description = descriptionInput.value.trim();
            const attachment = attachmentInput.files?.[0];

            if (!subject || !description) {
                showMessage(ticketMessage, 'alert-error', '–¢–µ–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.');
                return;
            }

            const subjectWithRoom = roomNumber ? `[–ö–∞–±–∏–Ω–µ—Ç: ${roomNumber}] ${subject}` : subject;

            try {
                let res;
                if (attachment) {
                    const fd = new FormData();
                    fd.set('subject', subjectWithRoom);
                    fd.set('description', description);
                    fd.set('attachment', attachment);
                    res = await fetch(`${API_BASE}/tickets/new`, { method: 'POST', body: fd, credentials: 'include' });
                } else {
                    res = await fetch(`${API_BASE}/tickets/new`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                        body: JSON.stringify({ subject: subjectWithRoom, description })
                    });
                }
                const isJson = (res.headers.get('content-type')||'').includes('application/json');
                const data = isJson ? await res.json() : { message: await res.text() };
                if (res.ok) {
                    showMessage(ticketMessage, 'alert-success', data.message || '–ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω.');
                    createTicketForm.reset();
                    attachmentPreview.innerHTML = ''; attachmentPreview.classList.add('hidden'); attachmentPreview.classList.remove('show');
                    await loadUserTickets();
                    switchTab('active-tickets');
                } else {
                    showMessage(ticketMessage, 'alert-error', data.message || `–û—à–∏–±–∫–∞ (${res.status}).`);
                }
            } catch (error) {
                showMessage(ticketMessage, 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ —Ç–∏–∫–µ—Ç–æ–≤
        async function loadUserTickets() {
            try {
                const res = await fetch(`${API_BASE}/tickets/my`, { credentials: 'include' });
                const tickets = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                activeTicketsTableBody.innerHTML = '';
                tickets
                    .filter(t => ['New', 'In Progress', 'On Hold'].includes(t.status))
                    .forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="ID">${t.id}</td>
                            <td data-label="–°—Ç–∞—Ç—É—Å"><span class="status-badge status-${t.status.replace(' ', '-')}">${toRu(t.status)}</span></td>
                            <td data-label="–¢–µ–º–∞">${escapeHtml(t.subject)}</td>
                            <td data-label="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è">${formatDate(t.created_at || t.createdAt)}</td>
                            <td data-label="–î–µ–π—Å—Ç–≤–∏–µ"><button class="btn btn-small" data-open-chat data-id="${t.id}" data-subject="${escapeHtml(t.subject)}" data-status="${t.status}">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button></td>
                        `;
                        activeTicketsTableBody.appendChild(tr);
                    });

                activeTicketsTableBody.querySelectorAll('[data-open-chat]').forEach(btn => {
                    btn.addEventListener('click', () => openChat({
                        id: btn.dataset.id,
                        subject: btn.dataset.subject,
                        status: btn.dataset.status
                    }, false));
                });
            } catch (e) {}
        }

        async function loadHistoryTickets() {
            try {
                const res = await fetch(`${API_BASE}/tickets/my`, { credentials: 'include' });
                const tickets = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                historyTicketsTableBody.innerHTML = '';
                tickets
                    .filter(t => ['Successful', 'Rejected'].includes(t.status) || t.closed_at)
                    .forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="ID">${t.id}</td>
                            <td data-label="–°—Ç–∞—Ç—É—Å"><span class="status-badge status-${(t.status || '').replace(' ', '-')}">${toRu(t.status || '')}</span></td>
                            <td data-label="–¢–µ–º–∞">${escapeHtml(t.subject)}</td>
                            <td data-label="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è">${formatDate(t.created_at || t.createdAt)}</td>
                            <td data-label="–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è">${t.closed_at ? formatDate(t.closed_at) : '-'}</td>
                            <td data-label="–î–µ–π—Å—Ç–≤–∏–µ"><button class="btn btn-outline btn-small" data-view-chat data-id="${t.id}" data-subject="${escapeHtml(t.subject)}" data-status="${t.status}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button></td>
                        `;
                        historyTicketsTableBody.appendChild(tr);
                    });

                historyTicketsTableBody.querySelectorAll('[data-view-chat]').forEach(btn => {
                    btn.addEventListener('click', () => openChat({
                        id: btn.dataset.id,
                        subject: btn.dataset.subject,
                        status: btn.dataset.status
                    }, true));
                });
            } catch (e) {}
        }

        // –ß–∞—Ç
        function setChatReadonlyState(readonly) {
            chatReadOnly = !!readonly;
            if (chatReadOnly) {
                chatReadonlyBanner.classList.remove('hidden');
                chatInputArea.classList.add('hidden');
            } else {
                chatReadonlyBanner.classList.add('hidden');
                chatInputArea.classList.remove('hidden');
            }
        }

        function closeAttachMenu(){
            if (!attachMenu) return;
            attachMenu.classList.remove('open');
            attachMenu.setAttribute('aria-hidden','true');
        }

        function closeChat() {
            if (activeTicketId) socket.emit('leaveTicket', activeTicketId);
            chatModal.style.display = 'none';
            chatBox.innerHTML = '';
            activeTicketId = null;
            chatAttachmentInput.value='';
            chatAttachmentPreview.innerHTML='';
            chatAttachmentPreview.classList.remove('show');
            chatAttachmentPreview.classList.add('hidden');
            setChatReadonlyState(false);
            closeAttachMenu();
        }
        closeChatButton.addEventListener('click', closeChat);

        async function openChat(ticket, forceReadonly = false) {
            // –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–∏ –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ ‚Äî –≤—ã–π–¥–µ–º
            if (activeTicketId && Number(activeTicketId) !== Number(ticket.id)) {
                socket.emit('leaveTicket', activeTicketId);
            }
            activeTicketId = Number(ticket.id);
            chatTicketIdDisplay.textContent = activeTicketId;
            chatTicketSubjectDisplay.textContent = ticket.subject || '';
            const status = ticket.status || '';
            const isClosed = ['Successful', 'Rejected'].includes(status);
            setChatReadonlyState(forceReadonly || isClosed);

            chatModal.style.display = 'block';
            closeAttachMenu();
            socket.emit('joinTicket', activeTicketId);
            await loadMessages(activeTicketId);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadMessages(ticketId) {
            try {
                const res = await fetch(`${API_BASE}/tickets/${ticketId}/messages`, { credentials: 'include' });
                const msgs = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                chatBox.innerHTML = '';
                msgs.forEach(renderMessage);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {}
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const self = (typeof msg.senderId !== 'undefined' ? (msg.senderId === currentUserId) : (msg.senderUsername === currentUsername));
            div.className = `message-item ${self ? 'self-message' : 'other-message'}`;
            const safeText = msg.messageText ? escapeHtml(msg.messageText) : '';
            let attachHtml = '';
            if (msg.attachmentUrl) {
                const url = msg.attachmentUrl;
                const isImg = url.match(/\.(png|jpg|jpeg|gif|webp|heic|heif)$/i);
                const isVid = url.match(/\.(mp4|webm|ogg|mov)$/i);
                if (isImg) {
                    attachHtml = `<div><img src="${url}" alt="–í–ª–æ–∂–µ–Ω–∏–µ" style="max-width:240px; border-radius:8px;"></div>`;
                } else if (isVid) {
                    attachHtml = `<div><video src="${url}" controls style="max-width:240px; border-radius:8px;"></video></div>`;
                } else {
                    attachHtml = `<div><a href="${url}" target="_blank" rel="noopener">üìé –í–ª–æ–∂–µ–Ω–∏–µ</a></div>`;
                }
            }
            const createdAt = msg.createdAt || new Date().toISOString();
            div.innerHTML = `
                ${safeText ? `<div>${safeText}</div>` : ''}
                ${attachHtml}
                <div class="message-meta">${escapeHtml(msg.senderUsername || '')} ‚Ä¢ ${formatDate(createdAt)}</div>
            `;
            chatBox.appendChild(div);
        }

        // –í–ª–æ–∂–µ–Ω–∏—è ‚Äî Telegram-like
        attachToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const opened = attachMenu.classList.toggle('open');
            attachMenu.setAttribute('aria-hidden', opened ? 'false' : 'true');
        });
        document.addEventListener('click', (e) => {
            if (!attachMenu) return;
            const insideMenu = attachMenu.contains(e.target);
            const onToggle = attachToggle.contains(e.target);
            if (!insideMenu && !onToggle) closeAttachMenu();
        });
        chatPickButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = 'image/*,video/*';
            chatAttachmentInput.removeAttribute('capture');
            chatAttachmentInput.click();
        });
        chatPhotoButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = 'image/*';
            chatAttachmentInput.setAttribute('capture', 'environment');
            chatAttachmentInput.click();
        });
        chatVideoButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = 'video/*';
            chatAttachmentInput.setAttribute('capture', 'environment');
            chatAttachmentInput.click();
        });
        chatAttachmentInput.addEventListener('change', () => {
            const file = chatAttachmentInput.files?.[0] || null;
            renderAttachmentPreview(chatAttachmentPreview, file, () => { chatAttachmentInput.value=''; });
            chatAttachmentPreview.classList.toggle('show', !!file);
            chatAttachmentPreview.classList.toggle('hidden', !file);
            chatAttachmentInput.accept = 'image/*,video/*';
            chatAttachmentInput.setAttribute('capture', 'environment');
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: —Ç–µ–∫—Å—Ç ‚Äî —Å–æ–∫–µ—Ç—ã, —Ñ–∞–π–ª—ã ‚Äî HTTP (—Å–µ—Ä–≤–µ—Ä —Å–∞–º —ç–º–∏—Ç–∏—Ç)
        chatSendButton.addEventListener('click', () => { closeAttachMenu(); sendCurrentMessage(); });
        chatInput.addEventListener('keydown', (e) => {
            if (chatReadOnly) return;
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); closeAttachMenu(); sendCurrentMessage(); }
        });

        async function sendCurrentMessage() {
            if (chatReadOnly) return;
            if (!activeTicketId) return;
            const text = chatInput.value.trim();
            const file = chatAttachmentInput.files?.[0] || null;
            if (!text && !file) return;
            try {
                if (file) {
                    const fd = new FormData();
                    fd.set('ticketId', String(activeTicketId));
                    if (text) fd.set('messageText', text);
                    fd.set('attachment', file);
                    const res = await fetch(`${API_BASE}/tickets/messages/send`, { method: 'POST', body: fd, credentials: 'include' });
                    if (!res.ok) {
                        const msg = await res.text();
                        throw new Error(msg || `–û—à–∏–±–∫–∞ (${res.status})`);
                    }
                } else {
                    socket.emit('sendMessage', { ticketId: activeTicketId, messageText: text });
                }
                chatInput.value = '';
                chatAttachmentInput.value = '';
                chatAttachmentPreview.innerHTML = '';
                chatAttachmentPreview.classList.remove('show');
                chatAttachmentPreview.classList.add('hidden');
            } catch (err) {
                alert(err.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        // –°–æ–∫–µ—Ç-—Å–æ–±—ã—Ç–∏—è
        socket.on('receiveMessage', (msg) => {
            if (Number(msg.ticketId) === Number(activeTicketId)) {
                renderMessage(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
        socket.on('ticketStatusUpdate', () => {
            loadUserTickets();
            loadHistoryTickets();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        (async function init() {
            await getAuthStatus();
            switchTab('active-tickets');
        })();
    </script>
</body>
</html>