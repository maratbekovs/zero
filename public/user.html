<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO Help Desk - –ö–ª–∏–µ–Ω—Ç</title>
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ZERO">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="apple-touch-icon" sizes="57x57"   href="/icons/apple-touch-icon-57.png">
    <link rel="apple-touch-icon" sizes="60x60"   href="/icons/apple-touch-icon-60.png">
    <link rel="apple-touch-icon" sizes="72x72"   href="/icons/apple-touch-icon-72.png">
    <link rel="apple-touch-icon" sizes="76x76"   href="/icons/apple-touch-icon-76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icons/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-touch-icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –ø—Ä–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .push-reminder {
            position: sticky; top: 0; z-index: 1000;
            display: none; gap: 12px; align-items: center; justify-content: space-between;
            padding: 10px 14px; background: #fff3cd; border-bottom: 1px solid #f0e1a6; color: #664d03;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
        }
        .push-reminder.open { display: flex; }
        .push-reminder .actions { display: flex; gap: 8px; flex-wrap: wrap; }

        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö */
        .chat-input-area {
            position: sticky; bottom: 0; z-index: 2; background: #fff;
            border-top: 1px solid #e2e8f0; padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
            display: flex; gap: 8px; align-items: center; flex-wrap: nowrap;
        }
        .chat-input-area #chat-input {
            flex: 1; min-width: 0; border-radius: 22px; padding: 12px 14px; font-size: 15px; min-height: 44px;
            border: 1px solid var(--border-color, #e2e8f0); outline: none;
        }
        .chat-input-area #chat-input:focus {
            border-color: var(--primary-color, #4361ee);
            box-shadow: 0 0 0 3px rgba(67,97,238,0.15);
        }
        .attach-toggle {
            background: #fff; border: 1px solid var(--border-color, #e2e8f0); color: var(--text-color, #2d3748);
            width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;
        }
        .send-button {
            width: 42px; height: 42px; border-radius: 12px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 18px;
        }
        .attach-menu {
            position: absolute; right: 16px; bottom: 60px; z-index: 3;
            background: #fff; border: 1px solid var(--border-color, #e2e8f0); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 8px; display: none; gap: 8px; align-items: center;
        }
        .attach-menu.open { display: flex; }
        .attach-menu .btn { width: auto; padding: 8px 10px; font-size: 13px; }

        #chat-attachment-preview.attachment-preview { display: none; }
        #chat-attachment-preview.attachment-preview.show { display: flex; flex-wrap: wrap; gap: 10px; }

        .notif-banner { margin-top: 10px; color:#2a9d8f; font-size: 0.9em; }
        .notif-banner.error { color:#e63946; }

        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–∏—è (–∫—Ä–∞—Å–Ω—ã–π –∫—Ä—É–∂–æ–∫ —Å X –ø–æ —Ü–µ–Ω—Ç—Ä—É) */
        .del-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: #dc3545;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,.2);
        }
        .del-btn:hover { filter: brightness(0.95); }
        .del-btn:focus { outline: none; box-shadow: 0 0 0 2px rgba(220,53,69,.3); }

        /* –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö + –∫—É—Ä—Å–æ—Ä —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ –∫–ª–∏–∫—É */
        .message-item .attach { margin: 4px 8px 8px 0; display: inline-block; }
        .message-item .attach img { display: block; max-width: 240px; border-radius: 8px; cursor: zoom-in; }
        .message-item .attach video { display: block; max-width: 240px; border-radius: 8px; }

        /* –ê–≤–∞—Ç–∞—Ä –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –∫—Ä—É–≥, –Ω–µ –∫–∞–∫ –≤–ª–æ–∂–µ–Ω–∏–µ */
        .message-item > img.avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            display: inline-block;
            vertical-align: middle;
            margin: 0 8px 4px 0;
            max-width: none;
            cursor: default;
            box-shadow: none;
        }

        /* –õ–∞–π—Ç–±–æ–∫—Å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .lightbox-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .lightbox-overlay.open { display: flex; }
        .lightbox-content { position: relative; max-width: 95vw; max-height: 95vh; }
        .lightbox-img { max-width: 95vw; max-height: 95vh; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .lightbox-close {
            position: absolute; top: -10px; right: -10px; width: 36px; height: 36px;
            border-radius: 50%; border: none; background: rgba(0,0,0,0.6); color:#fff;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 18px; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,.4);
        }

        /* –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-grid {
            display: grid; grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr); gap: 16px;
        }
        .profile-card { padding: 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; }
        .profile-row { display:flex; align-items:center; gap:12px; margin: 10px 0 16px; }
        .profile-avatar-lg { width:96px; height:96px; border-radius:50%; object-fit:cover; }
        .btn-row { display:flex; gap:8px; flex-wrap: wrap; }
        .muted-sm { color:#6c757d; font-size: 0.92em; }
        .profile-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

        @media (max-width: 900px){
            .profile-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px){
            .chat-content { max-height: 85vh; }
        }
    </style>
</head>
<body>
    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä Push -->
    <div id="push-reminder" class="push-reminder" role="region" aria-live="polite">
        <div id="push-reminder-text">–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ –∑–∞—è–≤–∫–∞–º.</div>
        <div class="actions">
            <button id="push-enable-btn" class="btn">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
            <button id="push-settings-btn" class="btn btn-outline" style="display:none;">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞</button>
        </div>
    </div>

    <div class="mobile-header"><h1>ZERO ü§ù Help Desk</h1></div>

    <div class="desktop-layout">
        <div class="sidebar">
            <div class="sidebar-header"><h1>ZERO ü§ù Help Desk</h1></div>
            <div class="nav-links">
                <a href="#" class="nav-link active" data-tab="active-tickets"><i>üì±</i> –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</a>
                <a href="#" class="nav-link" data-tab="history-tickets"><i>üìã</i> –ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="#" class="nav-link" data-tab="profile"><i>üë§</i> –ü—Ä–æ—Ñ–∏–ª—å</a>
            </div>
            <div class="sidebar-footer">
                <div class="user-info">
                    <p><strong id="sidebar-username"></strong></p>
                    <p id="sidebar-fullname"></p>
                    <p id="sidebar-phone"></p>
                </div>
                <button class="btn btn-danger logout-button">–í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="main-content">
            <div id="active-tickets" class="content-section active">
                <div class="section-header"><h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h2></div>

                <div class="card">
                    <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</h3>
                    <div id="ticket-message" class="alert hidden"></div>

                    <form id="create-ticket-form">
                        <div class="form-group">
                            <label for="room_number">–ù–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞:</label>
                            <input type="text" id="room_number" name="room_number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 312, –ê-104">
                        </div>

                        <div class="form-group">
                            <label for="subject">–¢–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∞:</label>
                            <input type="text" id="subject" name="subject" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É" required>
                        </div>

                        <div class="form-group">
                            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                            <textarea id="description" name="description" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É" required></textarea>
                        </div>

                        <div class="form-group">
                            <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ:</label>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                                <button type="button" id="btn-photo-capture" class="btn btn-muted btn-small">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                                <button type="button" id="btn-video-capture" class="btn btn-muted btn-small">–°–Ω—è—Ç—å –≤–∏–¥–µ–æ</button>
                                <button type="button" id="btn-pick-file" class="btn btn-outline btn-small">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                            </div>
                            <input type="file" id="attachment" accept="image/*,video/*" capture="environment" class="hidden" multiple>
                            <div id="attachment-preview" class="attachment-preview hidden" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
                        </div>

                        <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                    </form>
                </div>

                <div class="card">
                    <h3>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
                    <div class="table-container">
                        <table id="active-tickets-table" class="responsive">
                            <thead>
                            <tr>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¢–µ–º–∞</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="history-tickets" class="content-section">
                <div class="section-header"><h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2></div>
                <div class="card">
                    <div class="table-container">
                        <table id="history-tickets-table" class="responsive">
                            <thead>
                            <tr>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¢–µ–º–∞</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <p class="muted-sm" style="margin-top:10px;">
                        –ü–æ–¥—Ä–æ–±–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–æ–π ¬´–ü—Ä–æ—Å–º–æ—Ç—Ä¬ª.
                    </p>
                </div>
            </div>

            <div id="profile" class="content-section">
                <div class="section-header"><h2>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2></div>

                <div class="profile-grid">
                    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="profile-card" id="profile-main-card">
                        <div class="profile-row">
                            <img id="profile-avatar" class="profile-avatar-lg" alt="–ú–æ–π –∞–≤–∞—Ç–∞—Ä" src="/icons/user-placeholder.png">
                            <div>
                                <div><strong id="user-username-display">‚Äî</strong></div>
                                <div class="muted-sm" id="user-fullname-display">–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
                                <div class="muted-sm" id="user-phone-display">–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
                            </div>
                        </div>

                        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–º: —Å–∫—Ä—ã—Ç–æ –¥–æ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div class="profile-actions hidden" id="profile-actions">
                            <input type="file" id="avatar-input" accept="image/*" />
                            <button id="avatar-upload-btn" class="btn btn-outline btn-small">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
                            <div id="avatar-upload-msg" class="muted-sm"></div>
                        </div>

                        <hr style="margin:16px 0; border:none; border-top:1px solid #eaecef;">

                        <!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–≤–∏–¥–Ω—ã –≤–Ω–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                        <div class="btn-row" id="profile-view-buttons">
                            <button id="edit-user-info-button" class="btn btn-outline">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                            <button id="logout-button" class="btn btn-danger">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
                        </div>

                        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                        <form class="card hidden" id="edit-user-info-form" style="margin-top:12px;">
                            <h3 style="margin-top:0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
                            <div id="user-info-message" class="alert hidden"></div>
                            <div class="form-group">
                                <label for="edit_full_name">–§–ò–û:</label>
                                <input type="text" id="edit_full_name" name="full_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
                            </div>
                            <div class="form-group">
                                <label for="edit_phone_number">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                                <input type="text" id="edit_phone_number" name="phone_number" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" id="cancel-edit-button" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                    <div class="profile-card">
                        <h3 style="margin-top:0;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <p class="muted-sm">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ç–∞—Ç—É—Å–∞.</p>
                        <div class="btn-row">
                            <button id="enable-notifications-button" class="btn">–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                        </div>
                        <div id="notification-status" class="notif-banner hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-tab-bar">
        <a href="#" class="tab-item active" data-tab="active-tickets"><i>üì±</i><span>–ß–∞—Ç—ã</span></a>
        <a href="#" class="tab-item" data-tab="history-tickets"><i>üìã</i><span>–ò—Å—Ç–æ—Ä–∏—è</span></a>
        <a href="#" class="tab-item" data-tab="profile"><i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
    </div>

    <div id="chat-modal" class="chat-modal">
        <div class="chat-content">
            <div class="chat-header">
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <h2>–ß–∞—Ç: <span id="chat-ticket-subject"></span></h2>
                    <div id="responsible-block" class="muted" style="display:flex;align-items:center;gap:8px;">
                        <img id="moderator-avatar" class="avatar" alt="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" src="/icons/user-placeholder.png" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">
                        <span>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong id="moderator-name">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</strong></span>
                    </div>
                </div>
                <span class="close-button" title="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">&times;</span>
            </div>

            <div id="chat-readonly-banner" class="chat-readonly-banner hidden">
                –≠—Ç–æ—Ç —á–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ–ª—å–∑—è. –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –≤–ª–æ–∂–µ–Ω–∏–π.
            </div>

            <div id="chat-box" class="chat-box"></div>

            <div class="chat-input-area" id="chat-input-area">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                <input type="file" id="chat-attachment" multiple accept="image/*,video/*" capture="environment" style="display:none;">
                <button type="button" id="attach-toggle" class="attach-toggle" aria-label="–í–ª–æ–∂–µ–Ω–∏—è">Ôºã</button>
                <button id="chat-send-button" class="btn send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>

                <div class="attach-menu" id="attach-menu" role="menu" aria-hidden="true">
                    <button type="button" id="chat-pick-button" class="btn btn-outline btn-small">üìé –§–∞–π–ª</button>
                    <button type="button" id="chat-photo-button" class="btn btn-outline btn-small">üì∑ –§–æ—Ç–æ</button>
                    <button type="button" id="chat-video-button" class="btn btn-outline btn-small">üé• –í–∏–¥–µ–æ</button>
                </div>
            </div>

            <div id="chat-attachment-preview" class="attachment-preview" style="margin: 10px 20px;"></div>
        </div>
    </div>

    <!-- –õ–∞–π—Ç–±–æ–∫—Å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div id="lightbox" class="lightbox-overlay" aria-hidden="true">
        <div class="lightbox-content">
            <img id="lightbox-img" class="lightbox-img" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
            <button id="lightbox-close" class="lightbox-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        </div>
    </div>

    <script src="/js/avatars.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const API_BASE = '/api';

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        const navLinks = document.querySelectorAll('.nav-link');
        const tabItems = document.querySelectorAll('.tab-item');
        const contentSections = document.querySelectorAll('.content-section');

        // –ü—Ä–æ—Ñ–∏–ª—å refs
        const userUsernameDisplay = document.getElementById('user-username-display');
        const userFullnameDisplay = document.getElementById('user-fullname-display');
        const userPhoneDisplay = document.getElementById('user-phone-display');
        const sidebarUsername = document.getElementById('sidebar-username');
        const sidebarFullname = document.getElementById('sidebar-fullname');
        const sidebarPhone = document.getElementById('sidebar-phone');

        const editUserInfoButton = document.getElementById('edit-user-info-button');
        const editUserInfoForm = document.getElementById('edit-user-info-form');
        const userInfoMessage = document.getElementById('user-info-message');
        const editFullNameInput = document.getElementById('edit_full_name');
        const editPhoneNumberInput = document.getElementById('edit_phone_number');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        // Avatar controls (—Å–∫—Ä—ã—Ç—ã –¥–æ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const profileActions = document.getElementById('profile-actions');
        const avatarInput = document.getElementById('avatar-input');
        const avatarUploadBtn = document.getElementById('avatar-upload-btn');
        const avatarUploadMsg = document.getElementById('avatar-upload-msg');

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä–æ—Ñ–∏–ª—å)
        const notificationStatus = document.getElementById('notification-status');
        const enableNotificationsButton = document.getElementById('enable-notifications-button');

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä)
        const pushReminder = document.getElementById('push-reminder');
        const pushReminderText = document.getElementById('push-reminder-text');
        const pushEnableBtn = document.getElementById('push-enable-btn');
        const pushSettingsBtn = document.getElementById('push-settings-btn');

        // –ó–∞—è–≤–∫–∏ refs
        const createTicketForm = document.getElementById('create-ticket-form');
        const ticketMessage = document.getElementById('ticket-message');
        const activeTicketsTableBody = document.querySelector('#active-tickets-table tbody');
        const historyTicketsTableBody = document.querySelector('#history-tickets-table tbody');

        // –ü–æ–ª—è —Ñ–æ—Ä–º—ã –∑–∞—è–≤–∫–∏
        const roomNumberInput = document.getElementById('room_number');
        const subjectInput = document.getElementById('subject');
        const descriptionInput = document.getElementById('description');
        const attachmentInput = document.getElementById('attachment');
        const attachmentPreview = document.getElementById('attachment-preview');
        const btnPhotoCapture = document.getElementById('btn-photo-capture');
        const btnVideoCapture = document.getElementById('btn-video-capture');
        const btnPickFile = document.getElementById('btn-pick-file');

        // –ß–∞—Ç
        const socket = io('/', { withCredentials: true });
        let currentUserId = null;
        let currentUsername = null;
        let activeTicketId = null;
        let chatReadOnly = false;

        const chatModal = document.getElementById('chat-modal');
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatTicketSubjectDisplay = document.getElementById('chat-ticket-subject');
        const closeChatButton = document.querySelector('#chat-modal .close-button');
        const chatAttachmentInput = document.getElementById('chat-attachment');
        const chatAttachmentPreview = document.getElementById('chat-attachment-preview');
        const chatPhotoButton = document.getElementById('chat-photo-button');
        const chatVideoButton = document.getElementById('chat-video-button');
        const chatPickButton = document.getElementById('chat-pick-button');
        const chatInputArea = document.getElementById('chat-input-area');
        const chatReadonlyBanner = document.getElementById('chat-readonly-banner');
        const attachToggle = document.getElementById('attach-toggle');
        const attachMenu = document.getElementById('attach-menu');

        // –ê–Ω—Ç–∏–¥—É–±–ª–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ
        let isSendingMessage = false;
        const recentSendSigs = new Set();
        function makeMsgSignature(ticketId, text, filesArr) {
            const parts = [
                String(ticketId || ''),
                String(text || '').trim(),
                ...filesArr.map(f => `${f.name || ''}:${f.size || 0}:${f.type || ''}`)
            ];
            return parts.join('|');
        }
        function rememberSig(sig, ttlMs = 10000) {
            recentSendSigs.add(sig);
            setTimeout(() => recentSendSigs.delete(sig), ttlMs);
        }
        function genIdempKey() {
            return (crypto && crypto.randomUUID) ? crypto.randomUUID() : `m-${Date.now()}-${Math.random().toString(36).slice(2)}`;
        }

        // RU —Å—Ç–∞—Ç—É—Å—ã
        const statusMapRU = { 'New':'–ù–æ–≤–∞—è','In Progress':'–í —Ä–∞–±–æ—Ç–µ','On Hold':'–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏','Successful':'–£—Å–ø–µ—à–Ω–æ','Rejected':'–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' };
        const toRu = s => statusMapRU[s] || (s || '‚Äî');

        // PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {});
        }

        // Push helpers
        function isPushSupported() {
            return 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window;
        }
        function showNotifStatus(text, isError=false){
            if (!notificationStatus) return;
            notificationStatus.textContent = text;
            notificationStatus.classList.remove('hidden','error');
            if (isError) notificationStatus.classList.add('error');
        }
        function urlBase64ToUint8Array(base64String) {
            if (!base64String) return new Uint8Array();
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }
        async function fetchVapidPublicKey(){
            const res = await fetch(`${API_BASE}/auth/vapid-public-key`);
            if (!res.ok) throw new Error('No VAPID public key');
            const data = await res.json();
            return data.publicKey;
        }
        async function registerServiceWorkerAndSubscribe() {
            if (!isPushSupported()) return { ok:false, reason:'not_supported' };
            try {
                const registration = await navigator.serviceWorker.ready;
                let subscription = await registration.pushManager.getSubscription();
                if (!subscription) {
                    const publicKey = await fetchVapidPublicKey();
                    const appServerKey = urlBase64ToUint8Array(publicKey);
                    subscription = await registration.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });
                }
                const res = await fetch(`${API_BASE}/auth/save-subscription`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ subscription })
                });
                if (!res.ok) throw new Error('save-subscription failed');
                return { ok:true };
            } catch (e) {
                return { ok:false, reason: e?.message || 'subscribe_error' };
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä: –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞–∂–¥—ã–π –∑–∞—Ö–æ–¥, –ø–æ–∫–∞ –Ω–µ granted
        function updatePushReminderUI() {
            if (!isPushSupported()) {
                pushReminder.classList.remove('open');
                return;
            }
            const perm = Notification.permission;
            if (perm === 'granted') {
                pushReminder.classList.remove('open');
                return;
            }
            pushReminder.classList.add('open');
            if (perm === 'default') {
                pushReminderText.textContent = '–í–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ –∑–∞—è–≤–∫–∞–º.';
                pushEnableBtn.style.display = '';
                pushSettingsBtn.style.display = 'none';
            } else if (perm === 'denied') {
                pushReminderText.textContent = '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è.';
                pushEnableBtn.style.display = 'none';
                pushSettingsBtn.style.display = '';
            }
        }
        async function refreshPushUI() {
            if (!isPushSupported()) {
                showNotifStatus('Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.', true);
                return;
            }
            if (Notification.permission === 'granted') {
                const r = await registerServiceWorkerAndSubscribe();
                if (r.ok) showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.');
                else showNotifStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.', true);
            } else if (Notification.permission === 'denied') {
                showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', true);
            } else {
                notificationStatus.classList.add('hidden');
            }
            updatePushReminderUI();
        }
        pushEnableBtn?.addEventListener('click', async () => {
            try {
                const perm = await Notification.requestPermission();
                if (perm === 'granted') {
                    const r = await registerServiceWorkerAndSubscribe();
                    if (r.ok) showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.');
                }
            } catch {}
            updatePushReminderUI();
        });
        pushSettingsBtn?.addEventListener('click', () => {
            alert('–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –¥–æ–º–µ–Ω–∞.');
        });
        enableNotificationsButton?.addEventListener('click', async () => {
            if (!isPushSupported()) { showNotifStatus('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Push.', true); return; }
            try {
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') {
                    showNotifStatus('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.', true);
                    return;
                }
                const result = await registerServiceWorkerAndSubscribe();
                if (result.ok) {
                    showNotifStatus('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.');
                } else {
                    showNotifStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.', true);
                }
            } catch (e) {
                showNotifStatus('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.', true);
            }
            updatePushReminderUI();
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function switchTab(tabId) {
            contentSections.forEach(section => section.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            navLinks.forEach(link => { link.classList.remove('active'); if (link.dataset.tab === tabId) link.classList.add('active'); });
            tabItems.forEach(item => { item.classList.remove('active'); if (item.dataset.tab === tabId) item.classList.add('active'); });
            if (tabId === 'active-tickets') loadUserTickets();
            if (tabId === 'history-tickets') loadHistoryTickets();
            if (tabId === 'profile') refreshPushUI();
        }
        navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); switchTab(link.dataset.tab); }));
        tabItems.forEach(item => item.addEventListener('click', e => { e.preventDefault(); switchTab(item.dataset.tab); }));

        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function getAuthStatus() {
            try {
                const res = await fetch(`${API_BASE}/auth/status`, { credentials: 'include' });
                const data = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : {};
                if (!data.isLoggedIn) { window.location.href = '/'; return null; }
                currentUserId = data.userId; currentUsername = data.username;
                updateUserInfoDisplay({ username: data.username, full_name: data.full_name, phone_number: data.phone_number, avatar_url: data.avatar_url });
                return data;
            } catch (e) {
                showMessage(document.getElementById('auth-check-message'), 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
                return null;
            }
        }
        function updateUserInfoDisplay(userData) {
            const fullName = userData.full_name || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';
            const phoneNumber = userData.phone_number || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ';
            userUsernameDisplay.textContent = userData.username || '‚Äî';
            userFullnameDisplay.textContent = fullName;
            userPhoneDisplay.textContent = phoneNumber;
            sidebarUsername.textContent = userData.username || '‚Äî';
            sidebarFullname.textContent = fullName;
            sidebarPhone.textContent = phoneNumber;
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) profileAvatar.src = userData.avatar_url || '/icons/user-placeholder.png';
        }
        document.querySelectorAll('.logout-button, #logout-button').forEach(btn => btn.addEventListener('click', async () => {
            try { await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' }); } finally { window.location.href = '/'; }
        }));

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–∞–≤–∞—Ç–∞—Ä —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const profileViewButtons = document.getElementById('profile-view-buttons');
        editUserInfoButton.addEventListener('click', () => {
            editUserInfoForm.classList.remove('hidden');
            profileActions?.classList.remove('hidden');
            profileViewButtons?.classList.add('hidden');
            editFullNameInput.value = (userFullnameDisplay.textContent === '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ') ? '' : userFullnameDisplay.textContent;
            editPhoneNumberInput.value = (userPhoneDisplay.textContent === '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ') ? '' : userPhoneDisplay.textContent;
            hideMessage(userInfoMessage);
        });
        cancelEditButton.addEventListener('click', () => {
            editUserInfoForm.classList.add('hidden');
            profileActions?.classList.add('hidden');
            profileViewButtons?.classList.remove('hidden');
            hideMessage(userInfoMessage);
            if (avatarUploadMsg) avatarUploadMsg.textContent = '';
        });
        editUserInfoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = editFullNameInput.value.trim();
            const phoneNumber = editPhoneNumberInput.value.trim();
            try {
                const res = await fetch(`${API_BASE}/auth/update-profile`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                    body: JSON.stringify({ fullName, phoneNumber })
                });
                const isJson = (res.headers.get('content-type')||'').includes('application/json');
                const data = isJson ? await res.json() : { message: await res.text() };
                if (res.ok) {
                    showMessage(userInfoMessage, 'alert-success', data.message || '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
                    updateUserInfoDisplay({ username: currentUsername, full_name: fullName, phone_number: phoneNumber });
                    setTimeout(() => {
                        editUserInfoForm.classList.add('hidden');
                        profileActions?.classList.add('hidden');
                        profileViewButtons?.classList.remove('hidden');
                        hideMessage(userInfoMessage);
                        if (avatarUploadMsg) avatarUploadMsg.textContent = '';
                    }, 600);
                } else {
                    showMessage(userInfoMessage, 'alert-error', data.message || `–û—à–∏–±–∫–∞ (${res.status}).`);
                }
            } catch (err) {
                showMessage(userInfoMessage, 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
        function showMessage(element, type, text) { element.textContent = text; element.className = `alert ${type}`; element.classList.remove('hidden'); }
        function hideMessage(element) { element.classList.add('hidden'); }

        // ==== –°–û–ó–î–ê–ù–ò–ï –¢–ò–ö–ï–¢–ê: –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ ====
        let pendingTicketFiles = [];
        function removeTicketPendingAt(idx) {
            if (idx < 0 || idx >= pendingTicketFiles.length) return;
            pendingTicketFiles.splice(idx, 1);
            renderTicketPreviews(pendingTicketFiles);
        }
        function renderTicketPreviews(files) {
            attachmentPreview.innerHTML = '';
            const list = Array.from(files || []);
            if (!list.length) {
                attachmentPreview.classList.add('hidden');
                attachmentPreview.classList.remove('show');
                return;
            }
            const frag = document.createDocumentFragment();
            list.forEach((f, i) => {
                const url = URL.createObjectURL(f);
                const isImg = (f.type || '').startsWith('image/') || /\.(png|jpe?g|gif|webp|heic|heif)$/i.test(f.name || '');
                const isVid = (f.type || '').startsWith('video/') || /\.(mp4|webm|ogg|mov)$/i.test(f.name || '');
                const cell = document.createElement('div');
                cell.style.position = 'relative';
                cell.style.display = 'inline-block';
                cell.style.margin = '0 8px 8px 0';
                if (isImg) {
                    cell.innerHTML = `<img src="${url}" alt="preview" style="max-width:140px;max-height:110px;border-radius:8px;">`;
                } else if (isVid) {
                    cell.innerHTML = `<video src="${url}" controls style="max-width:160px;max-height:110px;border-radius:8px;"></video>`;
                } else {
                    cell.textContent = f.name || '–§–∞–π–ª';
                    cell.style.background = '#e9ecef';
                    cell.style.padding = '8px';
                    cell.style.borderRadius = '8px';
                }
                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'del-btn';
                del.setAttribute('aria-label','–£–¥–∞–ª–∏—Ç—å');
                del.textContent = '√ó';
                del.addEventListener('click', () => removeTicketPendingAt(i));
                cell.appendChild(del);
                frag.appendChild(cell);
            });
            attachmentPreview.appendChild(frag);
            attachmentPreview.classList.remove('hidden');
            attachmentPreview.classList.add('show');
        }

        btnPickFile.addEventListener('click', () => {
            attachmentInput.accept = 'image/*,video/*';
            attachmentInput.removeAttribute('capture');
            attachmentInput.click();
        });
        btnPhotoCapture.addEventListener('click', () => {
            attachmentInput.accept = 'image/*';
            attachmentInput.setAttribute('capture', 'environment');
            attachmentInput.click();
        });
        btnVideoCapture.addEventListener('click', () => {
            attachmentInput.accept = 'video/*';
            attachmentInput.setAttribute('capture', 'environment');
            attachmentInput.click();
        });
        attachmentInput.addEventListener('change', () => {
            const list = Array.from(attachmentInput.files || []);
            if (list.length) pendingTicketFiles.push(...list);
            attachmentInput.value = '';
            renderTicketPreviews(pendingTicketFiles);
            attachmentInput.accept = 'image/*,video/*';
            attachmentInput.setAttribute('capture', 'environment');
        });

        createTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomNumber = roomNumberInput.value.trim();
            const subject = subjectInput.value.trim();
            const description = descriptionInput.value.trim();

            if (!subject || !description) {
                showMessage(ticketMessage, 'alert-error', '–¢–µ–º–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.');
                return;
            }

            const subjectWithRoom = roomNumber ? `[–ö–∞–±–∏–Ω–µ—Ç: ${roomNumber}] ${subject}` : subject;

            try {
                let res;
                if (pendingTicketFiles.length > 0) {
                    const fd = new FormData();
                    fd.set('subject', subjectWithRoom);
                    fd.set('description', description);
                    pendingTicketFiles.forEach(f => fd.append('attachments', f));
                    // –±–µ–∑ fallback-–ø–æ–ª—è
                    res = await fetch(`${API_BASE}/tickets/create`, { method: 'POST', body: fd, credentials: 'include' });
                } else {
                    res = await fetch(`${API_BASE}/tickets/create`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                        body: JSON.stringify({ subject: subjectWithRoom, description })
                    });
                }
                const isJson = (res.headers.get('content-type')||'').includes('application/json');
                const data = isJson ? await res.json() : { message: await res.text() };
                if (res.ok) {
                    showMessage(ticketMessage, 'alert-success', data.message || '–ó–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω.');
                    createTicketForm.reset();
                    pendingTicketFiles = [];
                    attachmentPreview.innerHTML = '';
                    attachmentPreview.classList.add('hidden');
                    attachmentPreview.classList.remove('show');
                    await loadUserTickets();
                    switchTab('active-tickets');
                } else {
                    showMessage(ticketMessage, 'alert-error', data.message || `–û—à–∏–±–∫–∞ (${res.status}).`);
                }
            } catch (error) {
                showMessage(ticketMessage, 'alert-error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ —Ç–∏–∫–µ—Ç–æ–≤
        async function loadUserTickets() {
            try {
                const res = await fetch(`${API_BASE}/tickets/my`, { credentials: 'include' });
                const tickets = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                activeTicketsTableBody.innerHTML = '';
                tickets
                    .filter(t => ['New', 'In Progress', 'On Hold'].includes(t.status))
                    .forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="–°—Ç–∞—Ç—É—Å"><span class="status-badge status-${t.status.replace(' ', '-')}">${toRu(t.status)}</span></td>
                            <td data-label="–¢–µ–º–∞">${(t.subject || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>
                            <td data-label="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è">${new Date(t.created_at || t.createdAt).toLocaleString()}</td>
                            <td data-label="–î–µ–π—Å—Ç–≤–∏–µ"><button class="btn btn-small" data-open-chat data-id="${t.id}" data-subject="${(t.subject || '').replace(/"/g,'&quot;')}" data-status="${t.status}">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button></td>
                        `;
                        activeTicketsTableBody.appendChild(tr);
                    });

                activeTicketsTableBody.querySelectorAll('[data-open-chat]').forEach(btn => {
                    btn.addEventListener('click', () => openChat({
                        id: btn.dataset.id,
                        subject: btn.dataset.subject,
                        status: btn.dataset.status
                    }, false));
                });
            } catch (e) {
                console.error('loadUserTickets error', e);
            }
        }

        async function loadHistoryTickets() {
            try {
                const res = await fetch(`${API_BASE}/tickets/my`, { credentials: 'include' });
                const tickets = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                historyTicketsTableBody.innerHTML = '';
                tickets
                    .filter(t => ['Successful', 'Rejected'].includes(t.status) || t.closed_at)
                    .forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="–°—Ç–∞—Ç—É—Å"><span class="status-badge status-${(t.status || '').replace(' ', '-') }">${toRu(t.status || '')}</span></td>
                            <td data-label="–¢–µ–º–∞">${(t.subject || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>
                            <td data-label="–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è">${new Date(t.created_at || t.createdAt).toLocaleString()}</td>
                            <td data-label="–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è">${t.closed_at ? new Date(t.closed_at).toLocaleString() : '-'}</td>
                            <td data-label="–î–µ–π—Å—Ç–≤–∏–µ"><button class="btn btn-outline btn-small" data-view-chat data-id="${t.id}" data-subject="${(t.subject || '').replace(/"/g,'&quot;')}" data-status="${t.status}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button></td>
                        `;
                        historyTicketsTableBody.appendChild(tr);
                    });

                historyTicketsTableBody.querySelectorAll('[data-view-chat]').forEach(btn => {
                    btn.addEventListener('click', () => openChat({
                        id: btn.dataset.id,
                        subject: btn.dataset.subject,
                        status: btn.dataset.status
                    }, true));
                });
            } catch (e) {
                console.error('loadHistoryTickets error', e);
            }
        }

        // ===== –ß–ê–¢ =====

        function setChatReadonlyState(readonly) {
            chatReadOnly = !!readonly;
            if (chatReadOnly) {
                chatReadonlyBanner.classList.remove('hidden');
                chatInputArea.classList.add('hidden');
            } else {
                chatReadonlyBanner.classList.add('hidden');
                chatInputArea.classList.remove('hidden');
            }
        }
        function closeAttachMenu(){
            if (!attachMenu) return;
            attachMenu.classList.remove('open');
            attachMenu.setAttribute('aria-hidden','true');
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è —á–∞—Ç–∞
        let pendingFiles = [];
        function removePendingAt(idx) {
            if (idx < 0 || idx >= pendingFiles.length) return;
            pendingFiles.splice(idx, 1);
            renderChatPreviews(pendingFiles);
        }
        function renderChatPreviews(files) {
            chatAttachmentPreview.innerHTML = '';
            const list = Array.from(files || []);
            if (!list.length) {
                chatAttachmentPreview.classList.remove('show');
                chatAttachmentPreview.classList.add('hidden');
                return;
            }
            const frag = document.createDocumentFragment();
            list.forEach((f, i) => {
                const url = URL.createObjectURL(f);
                const isImg = (f.type || '').startsWith('image/') || /\.(png|jpe?g|gif|webp|heic|heif)$/i.test(f.name || '');
                const isVid = (f.type || '').startsWith('video/') || /\.(mp4|webm|ogg|mov)$/i.test(f.name || '');
                const cell = document.createElement('div');
                cell.style.display='inline-block';
                cell.style.marginRight='8px';
                cell.style.marginBottom='8px';
                cell.style.position='relative';
                if (isImg) {
                    cell.innerHTML = `<img src="${url}" alt="preview" style="max-width:140px;max-height:110px;border-radius:8px;">`;
                } else if (isVid) {
                    cell.innerHTML = `<video src="${url}" controls style="max-width:160px;max-height:110px;border-radius:8px;"></video>`;
                } else {
                    cell.textContent = f.name || '–§–∞–π–ª';
                    cell.style.background = '#e9ecef';
                    cell.style.padding = '8px';
                    cell.style.borderRadius = '8px';
                }
                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'del-btn';
                del.setAttribute('aria-label','–£–±—Ä–∞—Ç—å');
                del.textContent = '√ó';
                del.addEventListener('click', () => removePendingAt(i));
                cell.appendChild(del);
                frag.appendChild(cell);
            });
            chatAttachmentPreview.appendChild(frag);
            chatAttachmentPreview.classList.add('show');
            chatAttachmentPreview.classList.remove('hidden');
        }

        function closeChat() {
            if (activeTicketId) socket.emit('leaveTicket', activeTicketId);
            chatModal.style.display = 'none';
            chatBox.innerHTML = '';
            activeTicketId = null;
            pendingFiles = [];
            chatAttachmentInput.value='';
            chatAttachmentPreview.innerHTML='';
            chatAttachmentPreview.classList.remove('show');
            chatAttachmentPreview.classList.add('hidden');
            setChatReadonlyState(false);
            closeAttachMenu();
        }
        closeChatButton.addEventListener('click', closeChat);

        async function openChat(ticket, forceReadonly = false) {
            if (activeTicketId && Number(activeTicketId) !== Number(ticket.id)) {
                socket.emit('leaveTicket', activeTicketId);
            }
            activeTicketId = Number(ticket.id);
            chatTicketSubjectDisplay.textContent = ticket.subject || '';

            // –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π
            try {
                const res = await fetch(`/api/auth/ticket-summary/${ticket.id}`, { credentials:'include' });
                const data = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : {};
                const mod = data && data.moderator ? data.moderator : null;
                const modNameEl = document.getElementById('moderator-name');
                const modAvatarEl = document.getElementById('moderator-avatar');
                if (mod) {
                    if (modNameEl) modNameEl.textContent = mod.full_name || mod.username || '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π';
                    if (modAvatarEl) modAvatarEl.src = mod.avatar_url || '/icons/user-placeholder.png';
                } else {
                    if (modNameEl) modNameEl.textContent = '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                    if (modAvatarEl) modAvatarEl.src = '/icons/user-placeholder.png';
                }
            } catch(e) {}

            const status = ticket.status || '';
            const isClosed = ['Successful', 'Rejected'].includes(status);
            setChatReadonlyState(forceReadonly || isClosed);

            chatModal.style.display = 'block';
            closeAttachMenu();
            socket.emit('joinTicket', activeTicketId);
            await loadMessages(activeTicketId);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadMessages(ticketId) {
            try {
                const res = await fetch(`${API_BASE}/tickets/${ticketId}/messages`, { credentials: 'include' });
                const msgs = (res.headers.get('content-type')||'').includes('application/json') ? await res.json() : [];
                chatBox.innerHTML = '';
                msgs.forEach(renderMessage);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {
                console.error('loadMessages error', e);
            }
        }

        function renderAttachments(arr) {
            const container = document.createDocumentFragment();
            for (const a of (arr || [])) {
                const url = a.url;
                const mime = (a.mime_type || '').toLowerCase();
                const wrap = document.createElement('div');
                wrap.className = 'attach';
                if (mime.startsWith('image/') || /\.(png|jpe?g|gif|webp|heic|heif)$/i.test(url)) {
                    const im = document.createElement('img');
                    im.src = url; im.alt = '–í–ª–æ–∂–µ–Ω–∏–µ';
                    wrap.appendChild(im);
                } else if (mime.startsWith('video/') || /\.(mp4|webm|ogg|mov)$/i.test(url)) {
                    const vd = document.createElement('video');
                    vd.src = url; vd.controls = true;
                    wrap.appendChild(vd);
                } else {
                    wrap.innerHTML = `<a href="${url}" target="_blank" rel="noopener">üìé –í–ª–æ–∂–µ–Ω–∏–µ</a>`;
                }
                container.appendChild(wrap);
            }
            return container;
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const self = (typeof msg.senderId !== 'undefined' ? (Number(msg.senderId) === Number(currentUserId)) : (msg.senderUsername === currentUsername));
            div.className = `message-item ${self ? 'self-message' : 'other-message'}`;

            if (!self) {
                const img = document.createElement('img');
                img.className = 'avatar';
                img.alt = '–§–æ—Ç–æ';
                img.src = msg.senderAvatarUrl || '/icons/user-placeholder.png';
                // –Ø–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã/–≤–∏–¥ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–Ω–µ –≤–∫–ª–∞–¥–∫–∞-–≤–ª–æ–∂–µ–Ω–∏–µ)
                img.style.width = '28px';
                img.style.height = '28px';
                img.style.borderRadius = '50%';
                img.style.objectFit = 'cover';
                img.style.display = 'inline-block';
                img.style.verticalAlign = 'middle';
                img.style.marginRight = '8px';
                img.style.marginBottom = '4px';
                img.style.maxWidth = 'none';
                img.style.cursor = 'default';
                img.style.boxShadow = 'none';
                div.appendChild(img);
            }

            // –í–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏
            if (Array.isArray(msg.attachments) && msg.attachments.length) {
                div.appendChild(renderAttachments(msg.attachments));
            } else if (msg.attachmentUrl) {
                div.appendChild(renderAttachments([{ url: msg.attachmentUrl, mime_type: '', size: null }]));
            }

            // –¢–µ–∫—Å—Ç –Ω–∏–∂–µ –≤–ª–æ–∂–µ–Ω–∏–π
            const safeText = msg.messageText ? (msg.messageText || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
            if (safeText) {
                const textBlock = document.createElement('div');
                textBlock.className = 'bubble';
                textBlock.innerHTML = safeText;
                div.appendChild(textBlock);
            }

            const createdAt = msg.createdAt || new Date().toISOString();
            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = `${msg.senderUsername || msg.senderRole || ''} ‚Ä¢ ${new Date(createdAt).toLocaleString()}`;
            div.appendChild(meta);

            chatBox.appendChild(div);
        }

        // –ú–µ–Ω—é –≤–ª–æ–∂–µ–Ω–∏–π
        attachToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const opened = attachMenu.classList.toggle('open');
            attachMenu.setAttribute('aria-hidden', opened ? 'false' : 'true');
        });
        document.addEventListener('click', (e) => {
            if (!attachMenu) return;
            const insideMenu = attachMenu.contains(e.target);
            const onToggle = attachToggle.contains(e.target);
            if (!insideMenu && !onToggle) closeAttachMenu();
        });
        const CHAT_DEF_ACCEPT = 'image/*,video/*';
        chatPickButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = CHAT_DEF_ACCEPT;
            chatAttachmentInput.removeAttribute('capture');
            chatAttachmentInput.click();
        });
        chatPhotoButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = 'image/*';
            chatAttachmentInput.setAttribute('capture', 'environment');
            chatAttachmentInput.click();
        });
        chatVideoButton.addEventListener('click', () => {
            if (chatReadOnly) return;
            closeAttachMenu();
            chatAttachmentInput.accept = 'video/*';
            chatAttachmentInput.setAttribute('capture', 'environment');
            chatAttachmentInput.click();
        });

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ (–∏–º—è/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ) –¥–ª—è iOS/–∫–∞–º–µ—Ä—ã
        function normalizeFile(f) {
            try {
                const hasName = !!(f && f.name);
                const name = hasName ? f.name : '';
                const type = f?.type || '';
                const hasExt = /\.[a-z0-9]+$/i.test(name);
                if (hasName && hasExt) return f;
                let ext = '';
                if (type.startsWith('image/')) {
                    ext = type.split('/')[1] || 'jpg';
                } else if (type.startsWith('video/')) {
                    ext = type.split('/')[1] || 'mp4';
                } else {
                    ext = 'bin';
                }
                const base = hasName ? name.replace(/\.[a-z0-9]+$/i, '') : (type.startsWith('image/') ? 'photo' : (type.startsWith('video/') ? 'video' : 'file'));
                const newName = `${base}.${ext}`;
                return new File([f], newName, { type: type || 'application/octet-stream', lastModified: f.lastModified || Date.now() });
            } catch {
                return f;
            }
        }

        // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —á–∞—Ç–µ
        chatAttachmentInput.addEventListener('change', () => {
            const list = Array.from(chatAttachmentInput.files || []).map(normalizeFile);
            if (list.length) pendingFiles.push(...list);
            chatAttachmentInput.value = '';
            renderChatPreviews(pendingFiles);
            chatAttachmentInput.accept = CHAT_DEF_ACCEPT;
            chatAttachmentInput.setAttribute('capture', 'environment');
        });

        // –õ–∞–π—Ç–±–æ–∫—Å
        const lightboxEl = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxClose = document.getElementById('lightbox-close');
        function showLightbox(src) {
            lightboxImg.src = src;
            lightboxEl.classList.add('open');
            lightboxEl.setAttribute('aria-hidden','false');
        }
        function hideLightbox() {
            lightboxEl.classList.remove('open');
            lightboxEl.setAttribute('aria-hidden','true');
            lightboxImg.src = '';
        }
        chatBox.addEventListener('click', (e) => {
            const img = e.target.closest('.attach img');
            if (!img) return;
            showLightbox(img.src);
        });
        lightboxEl.addEventListener('click', (e) => {
            if (e.target === lightboxEl || e.target === lightboxClose) hideLightbox();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lightboxEl.classList.contains('open')) hideLightbox();
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—á–∞—Ç) ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
        chatSendButton.addEventListener('click', () => {
            if (isSendingMessage) return;
            closeAttachMenu();
            sendCurrentMessage();
        });
        chatInput.addEventListener('keydown', (e) => {
            if (chatReadOnly) return;
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (isSendingMessage) return;
                closeAttachMenu();
                sendCurrentMessage();
            }
        });

        // –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –¢–µ–∫—Å—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî —Ç–æ–ª—å–∫–æ –∫ –ø–µ—Ä–≤–æ–º—É.
        async function sendCurrentMessage() {
            if (chatReadOnly) return;
            if (!activeTicketId) return;
            const text = chatInput.value.trim();
            const files = pendingFiles.slice().map(normalizeFile);

            if (!text && files.length === 0) return;

            // –°–∏–≥–Ω–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–∞
            const sig = makeMsgSignature(activeTicketId, text, files);
            if (recentSendSigs.has(sig)) return;

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI
            if (isSendingMessage) return;
            isSendingMessage = true;
            const prevLabel = chatSendButton.textContent;
            chatSendButton.disabled = true;
            chatSendButton.textContent = '...';

            try {
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        const f = files[i];
                        const fd = new FormData();
                        fd.set('ticketId', String(activeTicketId));
                        if (i === 0 && text) fd.set('messageText', text);
                        fd.set('clientMessageId', genIdempKey());
                        fd.append('attachments', f);

                        const res = await fetch(`${API_BASE}/tickets/messages/send`, { method: 'POST', body: fd, credentials: 'include' });
                        if (!res.ok) {
                            const msg = await res.text();
                            console.error('Upload error:', res.status, msg);
                            throw new Error(msg || `–û—à–∏–±–∫–∞ (${res.status})`);
                        }
                    }
                } else {
                    const fd = new FormData();
                    fd.set('ticketId', String(activeTicketId));
                    fd.set('messageText', text);
                    fd.set('clientMessageId', genIdempKey());
                    const res = await fetch(`${API_BASE}/tickets/messages/send`, { method: 'POST', body: fd, credentials: 'include' });
                    if (!res.ok) throw new Error(await res.text() || `–û—à–∏–±–∫–∞ (${res.status})`);
                }

                rememberSig(sig, 10000);

                // –û—á–∏—Å—Ç–∫–∞
                chatInput.value = '';
                pendingFiles = [];
                chatAttachmentInput.value = '';
                chatAttachmentPreview.innerHTML = '';
                chatAttachmentPreview.classList.remove('show');
                chatAttachmentPreview.classList.add('hidden');
            } catch (err) {
                console.error('sendCurrentMessage error', err);
                alert(err.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            } finally {
                isSendingMessage = false;
                chatSendButton.disabled = false;
                chatSendButton.textContent = prevLabel || '‚û§';
            }
        }

        // –°–æ–∫–µ—Ç-—Å–æ–±—ã—Ç–∏—è
        socket.on('receiveMessage', (msg) => {
            if (Number(msg.ticketId) === Number(activeTicketId)) {
                renderMessage(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
        socket.on('ticketStatusUpdate', () => {
            loadUserTickets();
            loadHistoryTickets();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        (async function init() {
            await getAuthStatus();
            updatePushReminderUI(); // –≥–ª–æ–±–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            switchTab('active-tickets');
        })();
    </script>
</body>
</html>